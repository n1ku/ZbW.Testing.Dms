using System;
using System.Linq;
using System.Windows.Forms;
using System.Windows.Forms.VisualStyles;
using System.Windows.Input;
using System.Xml;
using System.Xml.Linq;
using System.Xml.XPath;
using ZbW.Testing.Dms.Client.ViewModels;

namespace ZbW.Testing.Dms.Client.Model
{
    public class Configuration
    {
        private string _repoLocationPath;
        private XDocument _configXml;
        private string _userName;
        private string _configFilePath;
        public Configuration(string usr)
        {
            _userName = usr;
            ConfigXml = new XDocument();
            if (!ConfigXmlExists()) GenerateConfigFile();

        }

        public string GetConfigFilePath()
        {
            string userName = Environment.UserName;
            string profilePath = "C:\\users\\" + userName;
            return profilePath + "\\DMSConfig.xml";
        }

        public string ConfigFilePath
        {
            get => _configFilePath;
            set => _configFilePath = value;
        }

        public string RepoLocationPath
        {
            get => _repoLocationPath;
            set => _repoLocationPath = value;
        }

        public XDocument ConfigXml
        {
            get => _configXml;
            set => _configXml = value;
        }

        public string UserName => _userName;

        public void DefineRepositoryPathDialog()
        {
            if(!ConfigXmlExists()) GenerateConfigFile();
            using ( var fld = new FolderBrowserDialog())
            {
                fld.ShowNewFolderButton = true;
                DialogResult result = fld.ShowDialog();

                if (result == DialogResult.OK && !string.IsNullOrWhiteSpace(fld.SelectedPath))
                {
                    RepoLocationPath = fld.SelectedPath;
                    AddRepoToXml();
                }
            }
        }

        public void GenerateConfigFile()
        {
            if (!ConfigXmlExists())
            {
                ConfigXml.Add(new XComment("Holds settings for each user || generated by DMS"));
                ConfigXml.Add(new XElement("DMS",
                        new XElement("Configs",
                            new XElement("Config", new XAttribute("configAddedAt", DateTime.Now), new XAttribute("userID", UserName),
                                new XElement("User", UserName),
                                new XElement("RepositoryPath", RepoLocationPath)
                            )
                        )
                    )
                );
                ConfigXml.Save(ConfigFilePath);
            }
            
        }

        public bool ConfigXmlExists()
        {
            string p = GetConfigFilePath();
            ConfigFilePath = p;
            return System.IO.File.Exists(ConfigFilePath);
        }

        public bool ConfigXmlUserKnown()
        {
            foreach (var element in ConfigXml.Elements())
            {
                XAttribute usr = element.Attribute("userId");
                if (usr != null)
                {
                    if (usr.Value.Equals(UserName)) return true;
                }
            }

            return false;
        }
        /**
        public void AddNewElement()
        {
            XElement configRecord;
            XDocument xmlFile = XDocument.Load(ConfigFilePath);
            configRecord = new XElement("Config", new XAttribute("configAddedAt", DateTime.Now),
                new XElement("User", UserName),
                new XElement("RepositoryPath", RepoLocationPath)
            );
            foreach (var element in xmlFile.Elements())
            {
                if (!ConfigXmlUserKnown())
                {
                    element.
                }
            }
        }*/

        public void AddRepoToXml()
        {
            
            string xp = "//RepositoryPath";

            var ele = ConfigXml.XPathSelectElement(xp);
            ele?.SetValue(RepoLocationPath);
            ConfigXml.Save(ConfigFilePath);
        }
    }
}